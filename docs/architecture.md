# 企业级博客系统 - 架构设计文档

## 1. 系统概述

### 1.1 项目简介

企业级博客系统是一个基于Go语言开发的高性能、可扩展的内容管理系统，提供了完整的博客功能，包括用户管理、文章管理、分类标签、评论系统等核心功能。

### 1.2 技术栈

- **编程语言**: Go 1.21+
- **Web框架**: Gin
- **数据库**: PostgreSQL 12+
- **缓存**: Redis 6+
- **搜索引擎**: Elasticsearch 8+（全文搜索）
- **认证**: JWT (JSON Web Token)
- **日志**: Zerolog
- **ORM**: GORM（使用原生 SQL 与轻量封装相结合）
- **前端**: React 18 + TypeScript + Vite

## 2. 系统架构

### 2.1 整体架构

系统采用分层架构设计，遵循关注点分离原则：

```
┌─────────────────────────────────────────┐
│         HTTP API Layer (Gin)            │
│  (Handlers, Middleware, Routes)         │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Business Logic Layer               │
│       (Services)                        │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Data Access Layer                  │
│       (Repository)                      │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Data Storage Layer                 │
│  (PostgreSQL, Redis, Elasticsearch)     │
└─────────────────────────────────────────┘
```

### 2.2 目录结构

```
enterprise-blog/
├── cmd/                    # 应用入口
│   ├── server/            # HTTP服务器
│   └── migrate/           # 数据库迁移工具
├── internal/              # 内部代码（不对外暴露）
│   ├── config/           # 配置管理
│   ├── models/           # 数据模型
│   ├── handlers/         # HTTP处理器
│   ├── services/         # 业务逻辑层
│   ├── repository/       # 数据访问层
│   ├── middleware/       # 中间件
│   ├── database/         # 数据库连接
│   └── search/           # 搜索引擎（Elasticsearch）
├── pkg/                  # 公共包（可对外暴露）
│   ├── jwt/             # JWT工具
│   ├── logger/          # 日志工具
│   └── validator/       # 验证器
├── migrations/           # 数据库迁移文件
├── tests/               # 测试文件
└── docs/                # 文档
```

### 2.3 分层架构详解

#### 2.3.1 Handler层（HTTP处理器）

职责：
- 接收HTTP请求
- 参数验证和绑定
- 调用Service层
- 返回HTTP响应

特点：
- 无业务逻辑
- 只负责请求/响应处理
- 统一的错误处理

#### 2.3.2 Service层（业务逻辑层）

职责：
- 实现业务逻辑
- 协调多个Repository
- 数据验证和转换
- 业务规则执行

特点：
- 独立于HTTP框架
- 可被多种接口复用（HTTP、gRPC等）
- 业务逻辑集中管理

#### 2.3.3 Repository层（数据访问层）

职责：
- 数据库CRUD操作
- SQL查询封装
- 数据模型转换

特点：
- 隐藏数据库实现细节
- 可替换数据源（从PostgreSQL切换到MySQL）
- 单一职责原则

## 3. 核心模块设计

### 3.1 用户认证模块

#### 3.1.1 认证流程

```
用户登录
   ↓
验证邮箱和密码
   ↓
生成JWT Token
   ↓
返回Token给客户端
   ↓
客户端在后续请求中携带Token
   ↓
中间件验证Token
   ↓
解析用户信息到上下文
```

#### 3.1.2 JWT Token结构

```json
{
  "user_id": "uuid",
  "username": "string",
  "role": "admin|editor|author|reader",
  "exp": timestamp,
  "iat": timestamp
}
```

### 3.2 文章管理模块

#### 3.2.1 文章状态流转

```
draft (草稿)
   ↓
published (已发布)
   ↓
archived (已归档)
```

#### 3.2.2 文章关联关系

- **作者**: 多对一关系（多篇文章对应一个作者）
- **分类**: 多对一关系（一篇文章属于一个分类）
- **标签**: 多对多关系（一篇文章可以有多个标签）

### 3.3 评论系统

#### 3.3.1 评论模型

- 支持嵌套评论（父子关系）
- 支持匿名评论（游客）
- 支持登录用户评论
- 评论审核机制

### 3.4 缓存策略

#### 3.4.1 Redis缓存

缓存内容：
- 文章列表（带分页）
- 分类列表
- 标签列表
- 热门文章

缓存键设计：
- `article:list:page:{page}:size:{size}`: 文章列表
- `category:list`: 分类列表
- `tag:list`: 标签列表
- `article:{id}`: 单篇文章

缓存失效：
- 文章更新/删除时清除相关缓存
- 分类/标签更新时清除列表缓存
- TTL过期策略

## 4. 数据库设计

### 4.1 ER图（实体关系图）

```
Users (用户)
  │
  ├─< Articles (文章) - 作者关系
  │    │
  │    ├─> Categories (分类) - 分类关系
  │    │
  │    └─> Tags (标签) - 多对多关系（通过article_tags）
  │
  └─< Comments (评论) - 评论者关系

Articles
  └─< Comments - 文章评论关系

Comments
  └─< Comments - 父子评论关系（自关联）
```

### 4.2 核心表结构

#### 4.2.1 users表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| username | VARCHAR(50) | 用户名（唯一） |
| email | VARCHAR(255) | 邮箱（唯一） |
| password | VARCHAR(255) | 加密后的密码 |
| role | VARCHAR(20) | 角色 |
| avatar | TEXT | 头像URL |
| bio | TEXT | 个人简介 |
| status | VARCHAR(20) | 状态 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 删除时间（软删除） |

#### 4.2.2 articles表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| title | VARCHAR(200) | 标题 |
| slug | VARCHAR(200) | URL友好标识（唯一） |
| content | TEXT | 内容 |
| excerpt | TEXT | 摘要 |
| cover_image | TEXT | 封面图 |
| status | VARCHAR(20) | 状态 |
| author_id | UUID | 作者ID（外键） |
| category_id | UUID | 分类ID（外键） |
| view_count | INTEGER | 浏览次数 |
| like_count | INTEGER | 点赞数 |
| comment_count | INTEGER | 评论数 |
| published_at | TIMESTAMP | 发布时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 删除时间（软删除） |

### 4.3 索引设计

为了优化查询性能，在以下字段上创建了索引：

- `users.email`: 登录查询
- `users.username`: 用户名查询
- `users.phone`: 手机号登录查询
- `articles.slug`: 通过slug查询文章
- `articles.author_id`: 查询用户文章
- `articles.category_id`: 按分类查询
- `articles.status`: 状态筛选
- `comments.article_id`: 查询文章评论
- `images.uploader_id`: 查询用户上传的图片
- `images.created_at`: 图片列表排序
- `images.tags`: 图片标签搜索（GIN索引）

## 5. API设计

### 5.1 RESTful API规范

系统遵循RESTful设计原则：

- **GET**: 获取资源
- **POST**: 创建资源
- **PUT**: 更新资源
- **DELETE**: 删除资源

### 5.2 API路由设计

```
/api/v1/
├── auth/
│   ├── POST /register        # 用户注册
│   └── POST /login           # 用户登录
├── users/
│   ├── GET /profile          # 获取当前用户信息（需认证）
│   └── PUT /profile          # 更新当前用户信息（需认证）
├── articles/
│   ├── GET /                 # 文章列表
│   ├── GET /:id              # 获取文章详情
│   ├── GET /slug/:slug       # 通过slug获取文章
│   ├── POST /                # 创建文章（需认证）
│   ├── PUT /:id              # 更新文章（需认证）
│   └── DELETE /:id           # 删除文章（需认证）
├── categories/
│   └── GET /                 # 分类列表
├── tags/
│   └── GET /                 # 标签列表
└── articles/:article_id/comments/
    ├── GET /                 # 获取文章评论
    └── POST /                # 创建评论
```

### 5.3 响应格式

#### 成功响应

```json
{
  "code": 200,
  "message": "success",
  "data": {...}
}
```

#### 分页响应

```json
{
  "code": 200,
  "message": "success",
  "data": [...],
  "meta": {
    "page": 1,
    "page_size": 10,
    "total": 100,
    "total_page": 10
  }
}
```

#### 错误响应

```json
{
  "code": 400,
  "message": "error message"
}
```

## 6. 中间件

### 6.1 认证中间件

- 验证JWT Token
- 解析用户信息到上下文
- 权限验证

### 6.2 日志中间件

- 记录请求日志
- 记录响应时间
- 错误日志记录

### 6.3 限流中间件

- 基于IP的限流
- Redis实现
- 可配置的限流阈值

### 6.4 CORS中间件

- 跨域资源共享支持
- 可配置允许的域名

## 7. 安全设计

### 7.1 密码安全

- 使用bcrypt进行密码加密
- 密码复杂度要求（最小6位）
- 密码不在日志中输出

### 7.2 JWT安全

- 使用HS256算法
- Token过期机制
- Secret密钥保护

### 7.3 SQL注入防护

系统实施了多层SQL注入防护措施：

1. **参数化查询**
   - 所有用户输入都通过参数化查询（`?` 占位符）绑定
   - 使用 GORM 的 `Raw()` 方法配合参数数组
   - 确保所有动态值都通过参数传递，而不是字符串拼接

2. **白名单验证**
   - 对于无法使用参数化查询的场景（如 ORDER BY 字段名），使用白名单验证
   - `SortBy` 字段：只允许预定义的字段名
   - `Order` 字段：只允许 "asc" 或 "desc"
   - 无效输入时回退到默认值

3. **字符验证和转义**
   - 对于全文搜索查询，验证只包含允许的字符
   - 转义特殊字符防止注入
   - 包含非法字符时使用安全默认值

4. **安全原则**
   - 永远不信任用户输入
   - 优先使用参数化查询
   - 无法参数化时使用白名单验证
   - 避免使用 `fmt.Sprintf` 直接拼接 SQL

### 7.4 XSS防护

- 输入验证和过滤
- 输出转义

## 8. 性能优化

### 8.1 数据库优化

- 索引优化
- 连接池配置
- 查询优化

### 8.2 缓存优化

- Redis缓存热点数据（文章详情、文章列表）
- 缓存预热
- 缓存失效策略
- 计数缓冲（浏览量、点赞数使用Redis缓冲，定时批量回刷数据库）

### 8.3 Elasticsearch全文搜索

- **完全迁移到Elasticsearch**：所有全文搜索都使用Elasticsearch
- **模糊搜索支持**：
  - 精确匹配（最高优先级）
  - 前缀匹配
  - 模糊匹配（支持拼写错误）
  - 通配符匹配
- **多字段搜索**：标题、摘要、内容，不同权重
- **排序**：默认按创建时间倒序，支持自定义排序
- **筛选**：支持状态、分类、作者等筛选条件

### 8.4 图片服务优化

- 静态文件服务：直接提供图片文件访问
- 图片元数据管理：数据库存储图片信息
- 图片搜索：支持按文件名、描述、标签搜索
- 图片选择器：前端支持从图片库选择封面图片

### 8.3 代码优化

- 避免不必要的内存分配
- 使用连接池
- 异步处理非关键操作

## 9. 部署架构

### 9.1 单机部署

```
┌─────────────────────┐
│   Application       │
│   (Go Server)       │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
┌───▼───┐    ┌───▼───┐
│  PG   │    │ Redis │
└───────┘    └───────┘
```

### 9.2 分布式部署（扩展）

```
        ┌─────────────┐
        │ Load Balancer│
        └──────┬───────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐ ┌───▼───┐ ┌───▼───┐
│ App 1 │ │ App 2 │ │ App 3 │
└───┬───┘ └───┬───┘ └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼───┐           ┌───▼───┐
│  PG   │           │ Redis │
│(Master)│           │(Cluster)│
└───────┘           └───────┘
```

## 10. 监控和日志

### 10.1 日志级别

- **DEBUG**: 调试信息
- **INFO**: 一般信息
- **WARN**: 警告信息
- **ERROR**: 错误信息

### 10.2 日志内容

- HTTP请求日志（方法、路径、状态码、耗时）
- 错误堆栈信息
- 业务关键操作日志

### 10.3 监控指标（建议）

- 请求量（QPS）
- 响应时间（P50、P95、P99）
- 错误率
- 数据库连接数
- Redis连接数

## 11. 扩展性设计

### 11.1 水平扩展

- 无状态设计，支持多实例部署
- 共享数据库和Redis
- 负载均衡

### 11.2 功能扩展

- 插件化设计
- 模块化架构
- 接口抽象

### 11.3 数据扩展

- 分表策略
- 读写分离
- 缓存分层

## 12. 总结

本系统采用分层架构设计，具有以下特点：

1. **高内聚低耦合**: 各层职责清晰，依赖关系明确
2. **易于测试**: 分层设计便于单元测试和集成测试
3. **易于维护**: 代码结构清晰，易于理解和修改
4. **高性能**: 使用缓存、索引等优化手段
5. **可扩展**: 支持水平扩展和功能扩展
6. **安全性**: 完善的认证授权和安全防护机制

系统适用于中等规模的企业级应用，可以支持5000+ QPS的并发请求。

